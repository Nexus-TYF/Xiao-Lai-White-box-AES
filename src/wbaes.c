#include "wbaes.h"

M128 shiftrows_matrix = {
    .M[0][0] = 0x8000000000000000,
    .M[1][0] = 0x4000000000000000,
    .M[2][0] = 0x2000000000000000,
    .M[3][0] = 0x1000000000000000,
    .M[4][0] = 0x800000000000000,
    .M[5][0] = 0x400000000000000,
    .M[6][0] = 0x200000000000000,
    .M[7][0] = 0x100000000000000,
    .M[8][0] = 0x800000,
    .M[9][0] = 0x400000,
    .M[10][0] = 0x200000,
    .M[11][0] = 0x100000,
    .M[12][0] = 0x80000,
    .M[13][0] = 0x40000,
    .M[14][0] = 0x20000,
    .M[15][0] = 0x10000,
    .M[16][0] = 0x0,
    .M[17][0] = 0x0,
    .M[18][0] = 0x0,
    .M[19][0] = 0x0,
    .M[20][0] = 0x0,
    .M[21][0] = 0x0,
    .M[22][0] = 0x0,
    .M[23][0] = 0x0,
    .M[24][0] = 0x0,
    .M[25][0] = 0x0,
    .M[26][0] = 0x0,
    .M[27][0] = 0x0,
    .M[28][0] = 0x0,
    .M[29][0] = 0x0,
    .M[30][0] = 0x0,
    .M[31][0] = 0x0,
    .M[32][0] = 0x80000000,
    .M[33][0] = 0x40000000,
    .M[34][0] = 0x20000000,
    .M[35][0] = 0x10000000,
    .M[36][0] = 0x8000000,
    .M[37][0] = 0x4000000,
    .M[38][0] = 0x2000000,
    .M[39][0] = 0x1000000,
    .M[40][0] = 0x0,
    .M[41][0] = 0x0,
    .M[42][0] = 0x0,
    .M[43][0] = 0x0,
    .M[44][0] = 0x0,
    .M[45][0] = 0x0,
    .M[46][0] = 0x0,
    .M[47][0] = 0x0,
    .M[48][0] = 0x0,
    .M[49][0] = 0x0,
    .M[50][0] = 0x0,
    .M[51][0] = 0x0,
    .M[52][0] = 0x0,
    .M[53][0] = 0x0,
    .M[54][0] = 0x0,
    .M[55][0] = 0x0,
    .M[56][0] = 0x8000000000,
    .M[57][0] = 0x4000000000,
    .M[58][0] = 0x2000000000,
    .M[59][0] = 0x1000000000,
    .M[60][0] = 0x800000000,
    .M[61][0] = 0x400000000,
    .M[62][0] = 0x200000000,
    .M[63][0] = 0x100000000,
    .M[64][0] = 0x0,
    .M[65][0] = 0x0,
    .M[66][0] = 0x0,
    .M[67][0] = 0x0,
    .M[68][0] = 0x0,
    .M[69][0] = 0x0,
    .M[70][0] = 0x0,
    .M[71][0] = 0x0,
    .M[72][0] = 0x0,
    .M[73][0] = 0x0,
    .M[74][0] = 0x0,
    .M[75][0] = 0x0,
    .M[76][0] = 0x0,
    .M[77][0] = 0x0,
    .M[78][0] = 0x0,
    .M[79][0] = 0x0,
    .M[80][0] = 0x800000000000,
    .M[81][0] = 0x400000000000,
    .M[82][0] = 0x200000000000,
    .M[83][0] = 0x100000000000,
    .M[84][0] = 0x80000000000,
    .M[85][0] = 0x40000000000,
    .M[86][0] = 0x20000000000,
    .M[87][0] = 0x10000000000,
    .M[88][0] = 0x80,
    .M[89][0] = 0x40,
    .M[90][0] = 0x20,
    .M[91][0] = 0x10,
    .M[92][0] = 0x8,
    .M[93][0] = 0x4,
    .M[94][0] = 0x2,
    .M[95][0] = 0x1,
    .M[96][0] = 0x0,
    .M[97][0] = 0x0,
    .M[98][0] = 0x0,
    .M[99][0] = 0x0,
    .M[100][0] = 0x0,
    .M[101][0] = 0x0,
    .M[102][0] = 0x0,
    .M[103][0] = 0x0,
    .M[104][0] = 0x80000000000000,
    .M[105][0] = 0x40000000000000,
    .M[106][0] = 0x20000000000000,
    .M[107][0] = 0x10000000000000,
    .M[108][0] = 0x8000000000000,
    .M[109][0] = 0x4000000000000,
    .M[110][0] = 0x2000000000000,
    .M[111][0] = 0x1000000000000,
    .M[112][0] = 0x8000,
    .M[113][0] = 0x4000,
    .M[114][0] = 0x2000,
    .M[115][0] = 0x1000,
    .M[116][0] = 0x800,
    .M[117][0] = 0x400,
    .M[118][0] = 0x200,
    .M[119][0] = 0x100,
    .M[120][0] = 0x0,
    .M[121][0] = 0x0,
    .M[122][0] = 0x0,
    .M[123][0] = 0x0,
    .M[124][0] = 0x0,
    .M[125][0] = 0x0,
    .M[126][0] = 0x0,
    .M[127][0] = 0x0,
    .M[0][1] = 0x0,
    .M[1][1] = 0x0,
    .M[2][1] = 0x0,
    .M[3][1] = 0x0,
    .M[4][1] = 0x0,
    .M[5][1] = 0x0,
    .M[6][1] = 0x0,
    .M[7][1] = 0x0,
    .M[8][1] = 0x0,
    .M[9][1] = 0x0,
    .M[10][1] = 0x0,
    .M[11][1] = 0x0,
    .M[12][1] = 0x0,
    .M[13][1] = 0x0,
    .M[14][1] = 0x0,
    .M[15][1] = 0x0,
    .M[16][1] = 0x800000000000,
    .M[17][1] = 0x400000000000,
    .M[18][1] = 0x200000000000,
    .M[19][1] = 0x100000000000,
    .M[20][1] = 0x80000000000,
    .M[21][1] = 0x40000000000,
    .M[22][1] = 0x20000000000,
    .M[23][1] = 0x10000000000,
    .M[24][1] = 0x80,
    .M[25][1] = 0x40,
    .M[26][1] = 0x20,
    .M[27][1] = 0x10,
    .M[28][1] = 0x8,
    .M[29][1] = 0x4,
    .M[30][1] = 0x2,
    .M[31][1] = 0x1,
    .M[32][1] = 0x0,
    .M[33][1] = 0x0,
    .M[34][1] = 0x0,
    .M[35][1] = 0x0,
    .M[36][1] = 0x0,
    .M[37][1] = 0x0,
    .M[38][1] = 0x0,
    .M[39][1] = 0x0,
    .M[40][1] = 0x80000000000000,
    .M[41][1] = 0x40000000000000,
    .M[42][1] = 0x20000000000000,
    .M[43][1] = 0x10000000000000,
    .M[44][1] = 0x8000000000000,
    .M[45][1] = 0x4000000000000,
    .M[46][1] = 0x2000000000000,
    .M[47][1] = 0x1000000000000,
    .M[48][1] = 0x8000,
    .M[49][1] = 0x4000,
    .M[50][1] = 0x2000,
    .M[51][1] = 0x1000,
    .M[52][1] = 0x800,
    .M[53][1] = 0x400,
    .M[54][1] = 0x200,
    .M[55][1] = 0x100,
    .M[56][1] = 0x0,
    .M[57][1] = 0x0,
    .M[58][1] = 0x0,
    .M[59][1] = 0x0,
    .M[60][1] = 0x0,
    .M[61][1] = 0x0,
    .M[62][1] = 0x0,
    .M[63][1] = 0x0,
    .M[64][1] = 0x8000000000000000,
    .M[65][1] = 0x4000000000000000,
    .M[66][1] = 0x2000000000000000,
    .M[67][1] = 0x1000000000000000,
    .M[68][1] = 0x800000000000000,
    .M[69][1] = 0x400000000000000,
    .M[70][1] = 0x200000000000000,
    .M[71][1] = 0x100000000000000,
    .M[72][1] = 0x800000,
    .M[73][1] = 0x400000,
    .M[74][1] = 0x200000,
    .M[75][1] = 0x100000,
    .M[76][1] = 0x80000,
    .M[77][1] = 0x40000,
    .M[78][1] = 0x20000,
    .M[79][1] = 0x10000,
    .M[80][1] = 0x0,
    .M[81][1] = 0x0,
    .M[82][1] = 0x0,
    .M[83][1] = 0x0,
    .M[84][1] = 0x0,
    .M[85][1] = 0x0,
    .M[86][1] = 0x0,
    .M[87][1] = 0x0,
    .M[88][1] = 0x0,
    .M[89][1] = 0x0,
    .M[90][1] = 0x0,
    .M[91][1] = 0x0,
    .M[92][1] = 0x0,
    .M[93][1] = 0x0,
    .M[94][1] = 0x0,
    .M[95][1] = 0x0,
    .M[96][1] = 0x80000000,
    .M[97][1] = 0x40000000,
    .M[98][1] = 0x20000000,
    .M[99][1] = 0x10000000,
    .M[100][1] = 0x8000000,
    .M[101][1] = 0x4000000,
    .M[102][1] = 0x2000000,
    .M[103][1] = 0x1000000,
    .M[104][1] = 0x0,
    .M[105][1] = 0x0,
    .M[106][1] = 0x0,
    .M[107][1] = 0x0,
    .M[108][1] = 0x0,
    .M[109][1] = 0x0,
    .M[110][1] = 0x0,
    .M[111][1] = 0x0,
    .M[112][1] = 0x0,
    .M[113][1] = 0x0,
    .M[114][1] = 0x0,
    .M[115][1] = 0x0,
    .M[116][1] = 0x0,
    .M[117][1] = 0x0,
    .M[118][1] = 0x0,
    .M[119][1] = 0x0,
    .M[120][1] = 0x8000000000,
    .M[121][1] = 0x4000000000,
    .M[122][1] = 0x2000000000,
    .M[123][1] = 0x1000000000,
    .M[124][1] = 0x800000000,
    .M[125][1] = 0x400000000,
    .M[126][1] = 0x200000000,
    .M[127][1] = 0x100000000
};

void printstate(unsigned char * in)
{
    for(int i = 0; i < 16; i++) 
    {
        printf("%.2X", in[i]);
    }
    printf("\n");
}

void wbaes_gen(u8 key[16])
{
    u8 expandedKey[176];
    expandKey (key, expandedKey);
    
    M16 L[10][8];
    M16 L_inv[10][8];
    M32 R[10][4];
    M32 R_inv[10][4];

    M128 M_R_inv[10];
    M128 M_L[10];

    M128 ex_out;
    M128 ex_in_inv;

    for(int i = 0; i < 10; i++)
    {
        for(int j = 0; j < 8; j++)
        {
            genMatpairM16(&L[i][j], &L_inv[i][j]);
        }
    }
    for(int i = 0; i < 10; i++)
    {
        for(int j = 0; j < 4; j++)
        {
            genMatpairM32(&R[i][j], &R_inv[i][j]);
        }
    }
    genMatpairM128(&ex_in, &ex_in_inv);
    genMatpairM128(&ex_out, &ex_out_inv);

    for(int i = 0; i < 10; i++)
    {
        MatrixcomM16to128(L[i][0], L[i][1], L[i][2], L[i][3], L[i][4], L[i][5], L[i][6], L[i][7], &M_L[i]);
    }
    for(int i = 0; i < 10; i++)
    {
        MatrixcomM32to128(R_inv[i][0], R_inv[i][1], R_inv[i][2], R_inv[i][3], &M_R_inv[i]);
    }

    //M 1
    M128 temp_m128;
    MatMulMatM128(shiftrows_matrix, ex_in_inv, &temp_m128);
    MatMulMatM128(M_L[0], temp_m128, &M[0]);

    //M 2-10
    for(int i = 0; i < 9; i++)
    {
        MatMulMatM128(shiftrows_matrix, M_R_inv[i], &temp_m128);
        MatMulMatM128(M_L[i + 1], temp_m128, &M[i + 1]);
    }

    //M 11
    MatMulMatM128(ex_out, M_R_inv[9], &M[10]);

    u32 Tyi[4][256];
    for (int x = 0; x < 256; x++)
    {
        Tyi[0][x] = (gMul(2, x) << 24) | (x << 16) | (x << 8) | gMul(3, x);
        Tyi[1][x] = (gMul(3, x) << 24) | (gMul(2, x) << 16) | (x << 8) | x;
        Tyi[2][x] = (x << 24) | (gMul(3, x) << 16) | (gMul(2, x) << 8) | x;
        Tyi[3][x] = (x << 24) | (x << 16) | (gMul(3, x) << 8) | gMul(2, x);
    }

    int columnindex[]={0, 0, 1, 1, 2, 2, 3, 3};
    //Round 1-9 LUT
    for(int i = 0; i < 9; i++)
    {
        shiftRows(expandedKey + 16 * i);
        for(int j = 0; j < 8; j++)
        {
            u16 temp_u16;
            u8 temp_u8_1, temp_u8_2;
            u32 temp_u32_1, temp_u32_2, temp_u32;
            for(int x = 0; x < 65536; x++)
            {
                temp_u16 = MatMulNumM16(L_inv[i][j], x);
                temp_u8_1 = (temp_u16 >> 8) & 0xff;
                temp_u8_2 = (temp_u16) & 0xff;
                temp_u8_1 = SBox[temp_u8_1 ^ expandedKey[16 * i + (2 * j)]];
                temp_u8_2 = SBox[temp_u8_2 ^ expandedKey[16 * i + (2 * j + 1)]];
                temp_u32_1 = Tyi[(2 * j) % 4][temp_u8_1];
                temp_u32_2 = Tyi[(2 * j + 1) % 4][temp_u8_2];
                temp_u32 = temp_u32_1 ^ temp_u32_2;
                TMC[i][j][x] = MatMulNumM32(R[i][columnindex[j]], temp_u32);
            }
        }
    }

    //Round 10 LUT
    shiftRows(expandedKey + 16 * 9);
    for(int j = 0; j < 8; j++)
    {
        u16 temp_u16;
        u8 temp_u8_1, temp_u8_2;
        u32 temp_u32;
        for(int x = 0; x < 65536; x++)
        {
            temp_u16 = MatMulNumM16(L_inv[9][j], x);
            temp_u8_1 = temp_u16 >> 8;
            temp_u8_2 = (temp_u16) & 0xff;
            temp_u8_1 = SBox[temp_u8_1 ^ expandedKey[16 * 9 + (2 * j)]] ^ expandedKey[16 * 10 + (2 * j)];
            temp_u8_2 = SBox[temp_u8_2 ^ expandedKey[16 * 9 + (2 * j + 1)]] ^ expandedKey[16 * 10 + (2 * j + 1)];
            temp_u16 = (temp_u8_1 << 8) | temp_u8_2;
            if (j % 2)
            {
                temp_u32 = temp_u16 & 0x0000ffff;
                TMC[9][j][x] = MatMulNumM32(R[9][columnindex[j]], temp_u32);
            }
            else
            {
                temp_u32 = (temp_u16 & 0x0000ffff) << 16;
                TMC[9][j][x] = MatMulNumM32(R[9][columnindex[j]], temp_u32);
            }
        }
    }
    return ;
}

void wbaes_encrypt (u8 input[16], u8 output[16])
{
    V128 state_M;
    u16 state_TMC_in[8];
    u32 state_TMC_out[4];
    u8 *temp_u8;
    u16 *temp_u16;
    u32 *temp_u32;
    for(int i = 0; i < 8; i++)
    {
        temp_u8 = (u8 *)&state_M.V[0];
        *(temp_u8 + (7 - i)) = input[i];
    }
    for(int i = 8; i < 16; i++)
    {
        temp_u8 = (u8 *)&state_M.V[1];
        *(temp_u8 + (15 - i)) = input[i];
    }

    for(int r = 0; r < 10; r++)
    {
        MatMulVecM128(M[r], state_M, &state_M);//matrix M

        for(int i = 0; i < 4; i++)
        {
            temp_u16 = (u16 *)&state_M.V[0];
            state_TMC_in[i] = *(temp_u16 + (3 - i));
        }
        for(int i = 4; i < 8; i++)
        {
            temp_u16 = (u16 *)&state_M.V[1];
            state_TMC_in[i] = *(temp_u16 + (7 - i));
        }

        for(int i = 0; i < 4; i++)//TMC lookup table
        {
            state_TMC_out[i] = TMC[r][2 * i][state_TMC_in[2 * i]] ^ TMC[r][(2 * i + 1)][state_TMC_in[(2 * i + 1)]];
        }

        for(int i = 0; i < 2; i++)
        {
            temp_u32 = (u32 *)&state_M.V[0];
            *(temp_u32 + (1 - i)) = state_TMC_out[i];
        }
        for(int i = 2; i < 4; i++)
        {
            temp_u32 = (u32 *)&state_M.V[1];
            *(temp_u32 + (3 - i)) = state_TMC_out[i];
        }
    }
    MatMulVecM128(M[10], state_M, &state_M);

    for(int i = 0; i < 8; i++)
    {
        temp_u8 = (u8 *)&state_M.V[0];
        output[i] = *(temp_u8 + (7 - i));
    }
    for(int i = 8; i < 16; i++)
    {
        temp_u8 = (u8 *)&state_M.V[1];
        output[i] = *(temp_u8 + (15 - i));
    }
}